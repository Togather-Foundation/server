name: CI

on:
  push:
    branches: [main, develop, 001-sel-backend]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Manual trigger for running full test suite

env:
  GO_VERSION: "1.24.12"
  COVERAGE_THRESHOLD: 35

jobs:
  # Lint and format check
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8
          args: --timeout=5m

      - name: Check formatting
        run: |
          if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'make fmt'"
            gofmt -l .
            exit 1
          fi

  vulncheck:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  # Unit tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out ./internal/...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unit
          fail_ci_if_error: false

  # Contract tests (JSON-LD, OpenAPI, SHACL validation)
  test-contracts:
    name: Contract Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[ci-full]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Python for SHACL validation
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pyshacl
        run: |
          pip install pyshacl rdflib
          pyshacl --version

      - name: Run contract tests
        run: go test -v -race ./tests/contracts/...
        env:
          SHACL_VALIDATION_ENABLED: "true"

      - name: Validate SHACL shapes
        run: make validate-shapes
        env:
          SHACL_VALIDATION_ENABLED: "true"

  # Integration tests (with PostgreSQL + testcontainers)
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[ci-full]')
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: sel_test
          POSTGRES_PASSWORD: sel_test_pass
          POSTGRES_DB: sel_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U sel_test; do
            echo "Waiting for postgres..."
            sleep 2
          done

      - name: Install migrate tool
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Run database migrations
        run: make migrate-up
        env:
          DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"

      - name: Run integration tests
        run: go test -v -race -p 1 -coverprofile=coverage-integration.out ./tests/integration/...
        env:
          DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"
          TEST_DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage-integration.out
          flags: integration
          fail_ci_if_error: false

  # Federation sync tests (T116)
  test-federation:
    name: Federation Sync Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[ci-full]')
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: sel_test
          POSTGRES_PASSWORD: sel_test_pass
          POSTGRES_DB: sel_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U sel_test; do
            echo "Waiting for postgres..."
            sleep 2
          done

      - name: Install migrate tool
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Run database migrations
        run: make migrate-up
        env:
          DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"

      - name: Run federation sync integration tests
        run: go test -v -race -p 1 ./tests/integration/... -run 'Federation|ChangeFeed|Sync'
        env:
          DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"
          TEST_DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"

      - name: Run federation sync contract tests
        run: go test -v ./tests/contracts/... -run 'Federation|ChangeFeed'

  # E2E tests
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[ci-full]')
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: sel_test
          POSTGRES_PASSWORD: sel_test_pass
          POSTGRES_DB: sel_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U sel_test; do
            echo "Waiting for postgres..."
            sleep 2
          done

      - name: Install migrate tool
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Run database migrations
        run: make migrate-up
        env:
          DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"

      - name: Run E2E tests
        run: go test -v -race ./tests/e2e/...
        env:
          DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"
          TEST_DATABASE_URL: "postgres://sel_test:sel_test_pass@localhost:5432/sel_test?sslmode=disable"

  # Coverage check (enforces 80% threshold)
  coverage:
    name: Coverage Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[ci-full]')
    needs: [test-unit, test-integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Python for SHACL validation
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pyshacl
        run: pip install pyshacl rdflib

      - name: Install bc for coverage threshold check
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Generate full coverage report
        run: make coverage
        continue-on-error: true
        env:
          SHACL_VALIDATION_ENABLED: "true"

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Current coverage: ${COVERAGE}%"
          echo "Threshold: ${COVERAGE_THRESHOLD}%"
          if (( $(echo "$COVERAGE >= $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "✓ Coverage meets threshold"
          else
            echo "✗ Coverage below threshold (${COVERAGE}% < ${COVERAGE_THRESHOLD}%)"
            exit 1
          fi

      - name: Upload full coverage report
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: full
          fail_ci_if_error: false

  # Build check
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build server
        run: make build

      - name: Check binary exists
        run: |
          if [ ! -f bin/togather-server ]; then
            echo "Build failed: binary not found"
            exit 1
          fi
          echo "Build successful"
          ls -lh bin/togather-server

  # SQLc generation check
  sqlc-check:
    name: SQLc Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install sqlc
        run: go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest

      - name: Generate SQLc code
        run: make sqlc-generate

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Generated SQLc code differs from committed version"
            echo "Run 'make sqlc-generate' and commit changes"
            git diff
            exit 1
          fi
