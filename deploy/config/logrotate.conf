# Logrotate configuration for Togather deployment logs
#
# This file configures automatic rotation of deployment, snapshot, and rollback logs
# to prevent disk space exhaustion while maintaining adequate history for debugging.
#
# Installation:
#   sudo cp deploy/config/logrotate.conf /etc/logrotate.d/togather
#   sudo chmod 644 /etc/logrotate.d/togather
#
# Manual rotation (testing):
#   sudo logrotate -f /etc/logrotate.d/togather
#
# Verify configuration:
#   sudo logrotate -d /etc/logrotate.d/togather
#
# See: man logrotate

# Deployment logs
# Location: /var/log/togather/deployments/
# Contains: deploy_*.log, rollback_*.log
/var/log/togather/deployments/*.log {
    # Rotate daily
    daily
    
    # Keep 90 days of deployment logs (for audit trail)
    rotate 90
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate if log file is empty
    notifempty
    
    # Compress rotated logs (saves significant disk space)
    compress
    
    # Delay compression until next rotation
    # (allows recent logs to remain uncompressed for easier viewing)
    delaycompress
    
    # Create new log file after rotation
    create 0640 root togather
    
    # Use date as suffix instead of .1, .2, etc.
    # e.g., deploy_20260130.log.gz instead of deploy.log.1.gz
    dateext
    dateformat -%Y%m%d
    
    # Keep old versions even if number of rotations is reached
    # (ensures audit trail isn't lost)
    maxage 90
    
    # Rotate even if file has already been rotated today
    # (useful if multiple deployments per day)
    copytruncate
    
    # Execute after rotation
    postrotate
        # Send SIGHUP to rsyslog (if using rsyslog)
        if [ -f /var/run/rsyslogd.pid ]; then
            kill -HUP $(cat /var/run/rsyslogd.pid) 2>/dev/null || true
        fi
    endscript
}

# Database snapshot logs
# Location: /var/log/togather/db-snapshots/
# Contains: snapshot_*.log, restore_*.log
/var/log/togather/db-snapshots/*.log {
    # Rotate weekly (less frequent than deployments)
    weekly
    
    # Keep 12 weeks (3 months) of snapshot logs
    rotate 12
    
    missingok
    notifempty
    compress
    delaycompress
    
    create 0640 root togather
    
    dateext
    dateformat -%Y%m%d
    
    # Max age of 90 days (aligned with snapshot retention)
    maxage 90
    
    copytruncate
}

# Application logs (if logging to files)
# Location: ~/.togather/logs/
# Contains: app.log, error.log
/home/*/.togather/logs/*.log {
    # Rotate daily
    daily
    
    # Keep 30 days of application logs
    rotate 30
    
    missingok
    notifempty
    compress
    delaycompress
    
    # Preserve permissions from original file
    copytruncate
    
    dateext
    dateformat -%Y%m%d
    
    maxage 30
    
    # Rotate when file size exceeds 100MB
    # (prevents single log file from growing too large)
    size 100M
}

# Docker container logs (if using file-based logging)
# Note: This is a fallback. Prefer structured logging to stdout
# and use Docker's built-in log rotation.
/var/lib/docker/containers/*/*.log {
    # Rotate daily
    daily
    
    # Keep 7 days only (Docker logs can be very large)
    rotate 7
    
    missingok
    notifempty
    compress
    delaycompress
    
    # Don't create new file (Docker manages this)
    nocreate
    
    copytruncate
    
    # Rotate when file exceeds 100MB
    size 100M
    
    # Remove logs older than 7 days regardless of rotation count
    maxage 7
}

# Health check logs (if separate from application logs)
/var/log/togather/health/*.log {
    daily
    rotate 7
    missingok
    notifempty
    compress
    delaycompress
    create 0640 root togather
    dateext
    dateformat -%Y%m%d
    maxage 7
}

# Migration logs
/var/log/togather/migrations/*.log {
    # Rotate weekly
    weekly
    
    # Keep 12 weeks (aligned with deployment history)
    rotate 12
    
    missingok
    notifempty
    compress
    delaycompress
    
    create 0640 root togather
    
    dateext
    dateformat -%Y%m%d
    
    maxage 90
}
