# Docker Compose configuration for Togather Server
# Base configuration for single-node deployment with app + database
# Reference: specs/001-deployment-infrastructure/spec.md FR-003, FR-005

# Network definition
networks:
  togather-net:
    driver: bridge
    name: togather-network

# Persistent volume definitions
volumes:
  postgres-data:
    name: togather-db-data
  postgres-snapshots:
    name: togather-db-snapshots

services:
  # ============================================================================
  # PostgreSQL Database Service
  # ============================================================================
  togather-db:
    # Custom build to include both PostGIS and pgvector extensions
    # Base: PostGIS 16-3.4 (includes PostgreSQL 16 + PostGIS)
    # Added: pgvector extension for semantic search
    build:
      context: .
      dockerfile: Dockerfile.postgres
    container_name: togather-db
    restart: unless-stopped
    # Load environment variables from root .env file (../../.env from docker-compose.yml location)
    env_file:
      - ../../.env
    networks:
      - togather-net
    ports:
      # Expose on localhost for development/debugging
      # Production: Remove or bind to 127.0.0.1 only
      # Default: 5433 to avoid conflicts with local PostgreSQL on 5432
      - "${POSTGRES_PORT:-5433}:5432"
    environment:
      # Database configuration from .env file
      POSTGRES_DB: ${POSTGRES_DB:-togather}
      POSTGRES_USER: ${POSTGRES_USER:-togather}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set in .env file}
      # PostgreSQL performance tuning (used by command flags below, not standard PG env vars)
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-100}
    volumes:
      # Persistent database storage
      - postgres-data:/var/lib/postgresql/data
      # Database snapshots for migration safety
      - postgres-snapshots:/snapshots
      # Custom initialization scripts to enable required extensions
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-togather} -d ${POSTGRES_DB:-togather}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # PostgreSQL command-line options
    command:
      - "postgres"
      # Enable query logging for debugging (disable in production)
      - "-c"
      - "log_statement=${POSTGRES_LOG_STATEMENT:-none}"
      # Connection settings
      - "-c"
      - "max_connections=${POSTGRES_MAX_CONNECTIONS:-100}"
      # Memory settings
      - "-c"
      - "shared_buffers=${POSTGRES_SHARED_BUFFERS:-256MB}"
      - "-c"
      - "effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}"
      # Enable extensions needed by SEL backend
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"

  # ============================================================================
  # Togather Server Application Service
  # ============================================================================
  app:
    # Use pre-built image when IMAGE_TAG is set (deployment mode)
    # Falls back to building if image doesn't exist (development mode)
    image: togather-server:${IMAGE_TAG:-latest}

    # Build from repository root using multi-stage Dockerfile
    # Only used if image doesn't exist (development mode)
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        # Version metadata injected at build time
        VERSION: ${VERSION:-dev}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    container_name: togather-server
    restart: unless-stopped
    # Load environment variables from root .env file (../../.env from docker-compose.yml location)
    env_file:
      - ../../.env
    networks:
      - togather-net
    # NOTE: Port mapping removed from base service to prevent conflicts in blue-green deployment
    # When using this compose file standalone, override with: -p "8080:8080"
    # In blue-green mode, the slots define their own ports (8081 for blue, 8082 for green)
    ports: []
    # Application depends on database being healthy
    depends_on:
      togather-db:
        condition: service_healthy
    environment:
      # Server configuration
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_BASE_URL: ${SERVER_BASE_URL:-http://localhost:8080}

      # Database connection
      # Default to internal Docker network hostname
      DATABASE_URL: ${DATABASE_URL:-postgresql://togather:togather@togather-db:5432/togather?sslmode=disable}
      DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS:-50}
      DATABASE_MAX_IDLE_CONNECTIONS: ${DATABASE_MAX_IDLE_CONNECTIONS:-10}
      DATABASE_SSL_MODE: ${DATABASE_SSL_MODE:-disable}

      # Authentication & Security
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET must be set in .env file}
      JWT_EXPIRY_HOURS: ${JWT_EXPIRY_HOURS:-24}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD must be set in .env file}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@togather.local}

      # Rate Limiting
      RATE_LIMIT_PUBLIC: ${RATE_LIMIT_PUBLIC:-60}
      RATE_LIMIT_AGENT: ${RATE_LIMIT_AGENT:-300}
      RATE_LIMIT_ADMIN: ${RATE_LIMIT_ADMIN:-1000}

      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}

      # Background Jobs
      JOB_RETRY_DEDUPLICATION: ${JOB_RETRY_DEDUPLICATION:-3}
      JOB_RETRY_RECONCILIATION: ${JOB_RETRY_RECONCILIATION:-10}
      JOB_RETRY_ENRICHMENT: ${JOB_RETRY_ENRICHMENT:-15}

      # Environment & Logging
      ENVIRONMENT: ${ENVIRONMENT:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      ENABLE_REQUEST_LOGGING: ${ENABLE_REQUEST_LOGGING:-true}
      REQUEST_LOG_BODY: ${REQUEST_LOG_BODY:-false}

      # Federation
      FEDERATION_NODE_NAME: ${FEDERATION_NODE_NAME:-node-1}
      FEDERATION_SYNC_ENABLED: ${FEDERATION_SYNC_ENABLED:-false}

      # Nominatim / Geocoding
      NOMINATIM_USER_EMAIL: ${NOMINATIM_USER_EMAIL:-nominatim@togather.foundation}
      NOMINATIM_BASE_URL: ${NOMINATIM_BASE_URL:-https://nominatim.openstreetmap.org}
      NOMINATIM_TIMEOUT_SECONDS: ${NOMINATIM_TIMEOUT_SECONDS:-5}
      NOMINATIM_RATE_LIMIT_RPS: ${NOMINATIM_RATE_LIMIT_RPS:-1.0}
      GEOCODING_DEFAULT_COUNTRY: ${GEOCODING_DEFAULT_COUNTRY:-ca}
      GEOCODING_MAX_RADIUS_KM: ${GEOCODING_MAX_RADIUS_KM:-100}
      GEOCODING_DEFAULT_RADIUS_KM: ${GEOCODING_DEFAULT_RADIUS_KM:-10}

      # External Services
      ARTSDATA_API_URL: ${ARTSDATA_API_URL:-https://api.artsdata.ca}
      WIKIDATA_SPARQL_ENDPOINT: ${WIKIDATA_SPARQL_ENDPOINT:-https://query.wikidata.org/sparql}

      # Feature Flags
      ENABLE_VECTOR_SEARCH: ${ENABLE_VECTOR_SEARCH:-false}
      ENABLE_AUTO_RECONCILIATION: ${ENABLE_AUTO_RECONCILIATION:-false}

      # Timeouts
      HTTP_READ_TIMEOUT_SECONDS: ${HTTP_READ_TIMEOUT_SECONDS:-30}
      HTTP_WRITE_TIMEOUT_SECONDS: ${HTTP_WRITE_TIMEOUT_SECONDS:-30}
      HTTP_IDLE_TIMEOUT_SECONDS: ${HTTP_IDLE_TIMEOUT_SECONDS:-120}
      DATABASE_QUERY_TIMEOUT_SECONDS: ${DATABASE_QUERY_TIMEOUT_SECONDS:-30}

      # Health Check
      HEALTH_CHECK_PATH: ${HEALTH_CHECK_PATH:-/health}
      HEALTH_CHECK_TIMEOUT_SECONDS: ${HEALTH_CHECK_TIMEOUT_SECONDS:-5}

      # Monitoring
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
      METRICS_PORT: ${METRICS_PORT:-9090}
      METRICS_PATH: ${METRICS_PATH:-/metrics}

      # Graceful Shutdown
      GRACEFUL_SHUTDOWN_TIMEOUT_SECONDS: ${GRACEFUL_SHUTDOWN_TIMEOUT_SECONDS:-30}
    healthcheck:
      # Health check using the /health endpoint
      test: ["CMD", "/app/server", "healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    # =========================================================================
    # Resource Limits
    # =========================================================================
    # IMPORTANT: These limits are commented out by default for development
    # flexibility and compatibility across different Docker environments.
    #
    # PRODUCTION RECOMMENDATION: Enable resource limits to:
    # - Prevent memory leaks from exhausting host resources
    # - Ensure predictable performance under load
    # - Enable proper capacity planning and autoscaling
    # - Protect against runaway processes
    #
    # Suggested production values (adjust based on your needs):
    # - CPUs: 1.0 (limit) / 0.25 (reservation) - Allows burst to 1 full core
    # - Memory: 512M (limit) / 128M (reservation) - Sufficient for typical load
    #
    # To enable in production:
    # 1. Uncomment the deploy section below
    # 2. Adjust limits based on your load testing results
    # 3. Monitor metrics to tune values over time
    #
    # Note: Resource limits require Docker Swarm mode or docker-compose v3.
    # For development Docker Desktop environments, these may be ignored.
    # =========================================================================
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'          # Maximum CPU cores
    #       memory: 512M         # Maximum memory
    #     reservations:
    #       cpus: '0.25'         # Guaranteed CPU
    #       memory: 128M         # Guaranteed memory
