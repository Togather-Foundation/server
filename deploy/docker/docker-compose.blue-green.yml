# Docker Compose configuration for Blue-Green Deployment
# Extends the base docker-compose.yml to add zero-downtime deployment capability
# Reference: specs/001-deployment-infrastructure/spec.md FR-009 (blue-green strategy)

# Blue-Green Deployment Strategy:
# ================================
# Run TWO instances of the app simultaneously: "blue" and "green"
# Only ONE receives traffic at a time via nginx reverse proxy
#
# Deployment Workflow:
# 1. Deploy new version to inactive slot (e.g., if blue is active, deploy to green)
# 2. Run health checks on new version in the inactive slot
# 3. Switch traffic to new version by updating nginx upstream (atomic cutover)
# 4. Keep old version running briefly for rollback capability
# 5. Stop old version after confirmation new version is stable
#
# Traffic Switching:
# - Controlled by nginx upstream configuration (deploy/docker/nginx.conf)
# - Deploy script (T021) will handle updating nginx config and reloading
# - Rollback is as simple as switching traffic back to the previous slot
#
# Slot Detection:
# - Each app instance knows its slot via SLOT environment variable
# - Used for logging and debugging which version is handling requests

# Import base configuration
# All services defined in base compose file are available here
include:
  - docker-compose.yml

services:
  # ============================================================================
  # Blue Slot - First Application Instance
  # ============================================================================
  togather-blue:
    # Extend the base app service configuration
    # This inherits all settings: build, environment, volumes, etc.
    extends:
      file: docker-compose.yml
      service: app
    
    # Override container name for blue slot
    container_name: togather-server-blue
    
    # Override port mapping to avoid conflicts
    # Blue slot exposed on host port 8081
    ports:
      - "8081:8080"
    
    # Add slot identifier to environment
    environment:
      # All environment variables from base app service are inherited
      # Add slot identifier for logging and debugging
      SLOT: blue
      
      # Override container name in logs
      CONTAINER_NAME: togather-server-blue
    
    # Blue and green share the same database
    # Database is NOT duplicated - schema is forward-compatible during deployment
    depends_on:
      togather-db:
        condition: service_healthy
    
    # Add label for identifying slot in docker ps and logs
    labels:
      com.togather.deployment.slot: blue
      com.togather.deployment.strategy: blue-green
    
    # Health check inherited from base app service
    # Deployment script will use this to verify blue slot is ready

  # ============================================================================
  # Green Slot - Second Application Instance
  # ============================================================================
  togather-green:
    # Extend the base app service configuration
    extends:
      file: docker-compose.yml
      service: app
    
    # Override container name for green slot
    container_name: togather-server-green
    
    # Override port mapping to avoid conflicts
    # Green slot exposed on host port 8082
    ports:
      - "8082:8080"
    
    # Add slot identifier to environment
    environment:
      # All environment variables from base app service are inherited
      # Add slot identifier for logging and debugging
      SLOT: green
      
      # Override container name in logs
      CONTAINER_NAME: togather-server-green
    
    # Blue and green share the same database
    depends_on:
      togather-db:
        condition: service_healthy
    
    # Add label for identifying slot
    labels:
      com.togather.deployment.slot: green
      com.togather.deployment.strategy: blue-green
    
    # Health check inherited from base app service

  # ============================================================================
  # Nginx Reverse Proxy - Traffic Router
  # ============================================================================
  # Routes all incoming traffic to either blue or green slot
  # Traffic switching is controlled by nginx upstream configuration
  nginx:
    image: nginx:alpine
    container_name: togather-proxy
    
    # Public-facing port
    # All client traffic comes through this port
    ports:
      - "${PROXY_PORT:-80}:80"
    
    # Network connectivity
    networks:
      - togather-net
    
    # Mount nginx configuration
    # Configuration file specifies which slot receives traffic
    volumes:
      # Read-only mount to prevent accidental modification
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Optional: Custom error pages
      # - ./nginx-errors:/usr/share/nginx/errors:ro
    
    # Proxy depends on both slots being available
    # This ensures slots are running before proxy starts
    depends_on:
      togather-blue:
        condition: service_healthy
      togather-green:
        condition: service_healthy
    
    # Health check for proxy itself
    healthcheck:
      # Check that nginx is responding and can reach upstream
      test: ["CMD-SHELL", "wget -q --spider http://localhost:80/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    # Restart policy
    restart: unless-stopped
    
    # Labels for management
    labels:
      com.togather.deployment.role: proxy
      com.togather.deployment.strategy: blue-green
    
    # Resource limits (proxy is lightweight)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

# Networks configuration inherited from base docker-compose.yml
# All services (togather-db, blue, green, nginx) share the togather-net network

# Volumes configuration inherited from base docker-compose.yml
# Database volumes (postgres-data, postgres-snapshots) are shared

# Usage Instructions:
# ===================
#
# 1. Start both slots with nginx proxy:
#    docker compose -f docker-compose.yml -f docker-compose.blue-green.yml up -d
#
# 2. Check which slot is active:
#    cat deploy/docker/nginx.conf | grep "server togather-server-"
#
# 3. Deploy new version to inactive slot:
#    - If blue is active, update green:
#      docker compose -f docker-compose.blue-green.yml up -d --no-deps togather-green
#    - If green is active, update blue:
#      docker compose -f docker-compose.blue-green.yml up -d --no-deps togather-blue
#
# 4. Run health checks on updated slot:
#    curl http://localhost:8081/health  # Blue slot
#    curl http://localhost:8082/health  # Green slot
#
# 5. Switch traffic to updated slot:
#    - Update nginx.conf to point to the new slot
#    - Reload nginx: docker compose -f docker-compose.blue-green.yml exec nginx nginx -s reload
#
# 6. Verify traffic is flowing to new slot:
#    curl http://localhost/health
#    docker compose -f docker-compose.blue-green.yml logs -f togather-green  # or togather-blue
#
# 7. After confirmation, stop old slot (optional):
#    docker compose -f docker-compose.blue-green.yml stop togather-blue  # or togather-green
#
# Rollback:
# =========
# If new version has issues, switch traffic back to old slot:
# 1. Update nginx.conf to point to old slot
# 2. Reload nginx: docker compose -f docker-compose.blue-green.yml exec nginx nginx -s reload
# 3. Traffic is now back on the stable version (zero downtime)
#
# Notes:
# ======
# - Both slots share the same database (single source of truth)
# - Database migrations must be forward-compatible (old code runs against new schema during cutover)
# - Deploy script (T021) will automate steps 3-6 above
# - Manual testing can be done by accessing slots directly on ports 8081/8082
# - Production deployments should use the deploy script for safety checks
