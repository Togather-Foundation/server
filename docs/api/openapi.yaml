openapi: 3.1.0
info:
  title: Shared Events Library (SEL) API
  version: 1.0.0
  description: |
    RESTful API for the Shared Events Library, a federated events commons 
    enabling discovery, submission, and management of cultural events.
    
    ## Authentication
    - **Public**: No authentication required for read endpoints
    - **Agents**: API key in `Authorization: Bearer <key>` header
    - **Admins**: JWT token in `Authorization: Bearer <token>` header
    
    ## Content Negotiation
    API endpoints return JSON/JSON-LD via `Accept` header:
    - `application/ld+json` - JSON-LD (default)
    - `application/json` - JSON-LD (alias)
    
    ## Pagination
    List endpoints use cursor-based pagination with `after` and `limit` parameters.
    Default limit is 50, maximum is 200.
    
    ### Cursor Format
    Cursors are opaque base64url-encoded strings (RFC 4648, URL-safe, no padding).
    - **Event cursors**: Encode timestamp + ULID for stable ordering
    - **Change feed cursors**: Encode sequence number for federation sync
    
    **Important**: Treat cursors as opaque strings. Use the `next_cursor` value from
    API responses as-is. Do not parse, decode, or modify cursor values.
    
    Example pagination:
    ```
    GET /api/v1/events?limit=50
    -> returns { items: [...], next_cursor: "MTcwNjg4NjAwMD..." }
    
    GET /api/v1/events?limit=50&after=MTcwNjg4NjAwMD...
    -> returns next page
    ```
  contact:
    name: SEL Team
    url: https://togather.foundation
    email: hello@togather.foundation
  license:
    name: CC0 1.0
    url: https://creativecommons.org/publicdomain/zero/1.0/

servers:
  - url: https://{node}/api/v1
    description: SEL Node API
    variables:
      node:
        default: toronto.togather.foundation
        description: SEL node domain

tags:
  - name: Admin
    description: Administrative operations (requires admin auth)
  - name: Events
    description: Event discovery and submission
  - name: Feeds
    description: Change feeds for federation
  - name: Health
    description: Health check endpoints
  - name: Organizations
    description: Organizer information
  - name: Places
    description: Venue information

paths:
  /events:
    get:
      operationId: listEvents
      summary: List events
      description: Query events with optional filters. Returns paginated JSON-LD.
      tags: [Events]
      security: []
      parameters:
        - $ref: '#/components/parameters/startDate'
        - $ref: '#/components/parameters/endDate'
        - $ref: '#/components/parameters/city'
        - $ref: '#/components/parameters/venueId'
        - $ref: '#/components/parameters/organizerId'
        - $ref: '#/components/parameters/lifecycleState'
        - $ref: '#/components/parameters/eventDomain'
        - $ref: '#/components/parameters/query'
        - $ref: '#/components/parameters/keywords'
        - $ref: '#/components/parameters/after'
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Paginated list of events
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/EventListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

    post:
      operationId: createEvent
      summary: Submit a new event
      description: |
        Submit a new event to the library. Requires agent or admin authentication.
        Events are auto-published immediately and appear in admin review queue
        if flagged or low-confidence.
      tags: [Events]
      security:
        - apiKey: []
        - bearerAuth: []
      requestBody:
        description: Event data in JSON-LD or JSON format
        required: true
        content:
          application/ld+json:
            schema:
              $ref: '#/components/schemas/EventInput'
          application/json:
            schema:
              $ref: '#/components/schemas/EventInput'
      responses:
        '201':
          description: Event created successfully
          headers:
            Location:
              description: URI of the created event
              schema:
                type: string
                format: uri
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Duplicate event (idempotent - returns existing event)
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Event'

  /events/{id}:
    get:
      operationId: getEvent
      summary: Get event by ID
      description: Retrieve a single event by its ULID. Supports content negotiation.
      tags: [Events]
      security: []
      parameters:
        - $ref: '#/components/parameters/eventId'
      responses:
        '200':
          description: Event details
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Event'
        '404':
          $ref: '#/components/responses/NotFound'

  /events/batch:
    post:
      operationId: createEventBatch
      summary: Submit multiple events in a batch
      description: |
        Submit multiple events for background processing. Returns immediately with a batch ID
        and job status URL. Use the batch status endpoint to check processing results.
        
        Maximum batch size: 100 events. Each event in the batch is processed independently,
        with individual success/failure tracking.
      tags: [Events]
      security:
        - apiKey: []
        - bearerAuth: []
      requestBody:
        description: Array of events for batch processing (max 100 events)
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - events
              properties:
                events:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    $ref: '#/components/schemas/EventInput'
      responses:
        '202':
          description: Batch accepted for processing
          content:
            application/json:
              schema:
                type: object
                properties:
                  '@context':
                    type: string
                  '@type':
                    type: string
                    enum: [BatchSubmission]
                  batch_id:
                    type: string
                    description: Unique identifier for this batch submission
                  job_id:
                    type: integer
                    description: River job queue ID
                  status:
                    type: string
                    enum: [processing]
                  status_url:
                    type: string
                    format: uri
                    description: URL to check batch processing status
                  submitted:
                    type: integer
                    description: Number of events in the batch
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /batch-status/{id}:
    get:
      operationId: getBatchStatus
      summary: Get batch processing status
      description: |
        Retrieve the status and results of a batch event submission. Returns 404 if
        the batch is still processing or doesn't exist.
      tags: [Events]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Batch ID returned from batch submission
      responses:
        '200':
          description: Batch processing completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  '@context':
                    type: string
                  '@type':
                    type: string
                    enum: [BatchSubmissionResult]
                  batch_id:
                    type: string
                  status:
                    type: string
                    enum: [completed]
                  completed_at:
                    type: string
                    format: date-time
                  total:
                    type: integer
                    description: Total number of events processed
                  created:
                    type: integer
                    description: Number of events successfully created
                  failed:
                    type: integer
                    description: Number of events that failed validation/processing
                  duplicates:
                    type: integer
                    description: Number of duplicate events detected
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        index:
                          type: integer
                          description: Index of event in original batch array
                        status:
                          type: string
                          enum: [created, failed, duplicate]
                        event_id:
                          type: string
                          description: ULID of created/duplicate event (if successful)
                        error:
                          type: string
                          description: Error message (if failed)
        '404':
          description: Batch not found or still processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

        '410':
          $ref: '#/components/responses/Gone'

  /places:
    get:
      operationId: listPlaces
      summary: List places
      description: Query places (venues) with optional filters. Returns paginated JSON-LD.
      tags: [Places]
      security: []
      parameters:
        - $ref: '#/components/parameters/city'
        - $ref: '#/components/parameters/query'
        - $ref: '#/components/parameters/after'
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Paginated list of places
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/PlaceListResponse'

  /places/{id}:
    get:
      operationId: getPlace
      summary: Get place by ID
      description: Retrieve a single place (venue) by its unique identifier. Returns JSON-LD.
      tags: [Places]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: Unique identifier of the place (ULID or URI)
          schema:
            type: string
      responses:
        '200':
          description: Place details
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Place'
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations:
    get:
      operationId: listOrganizations
      summary: List organizations
      description: Query organizations (event organizers) with optional filters. Returns paginated JSON-LD.
      tags: [Organizations]
      security: []
      parameters:
        - $ref: '#/components/parameters/query'
        - $ref: '#/components/parameters/after'
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Paginated list of organizations
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/OrganizationListResponse'

  /organizations/{id}:
    get:
      operationId: getOrganization
      summary: Get organization by ID
      description: Retrieve a single organization by its unique identifier. Returns JSON-LD.
      tags: [Organizations]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: Unique identifier of the organization (ULID or URI)
          schema:
            type: string
      responses:
        '200':
          description: Organization details
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Organization'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/events/pending:
    get:
      operationId: listPendingEvents
      summary: List events awaiting review
      description: Returns events flagged for admin review (low confidence, validation issues, etc.)
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/after'
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Paginated list of pending events
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/EventListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/events/{id}:
    put:
      operationId: updateEvent
      summary: Update an event
      description: Admin endpoint to edit event details. Increments version and logs change.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/eventId'
      requestBody:
        description: Updated event data with version for optimistic locking
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventUpdateInput'
      responses:
        '200':
          description: Event updated
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Event'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Version conflict (optimistic locking)
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

    delete:
      operationId: deleteEvent
      summary: Delete an event
      description: Soft delete - returns 410 Gone with tombstone thereafter
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/eventId'
      responses:
        '204':
          description: Event deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/events/merge:
    post:
      operationId: mergeEvents
      summary: Merge duplicate events
      description: |
        Merge source event into target event. Source event will return 410 Gone 
        with sameAs link to canonical event.
        
        Note: Automatic duplicate detection (/admin/duplicates list endpoint) 
        is not yet implemented. Use this endpoint for manual merges.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      requestBody:
        description: Source and target event IDs for merge operation
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sourceId, targetId]
              properties:
                sourceId:
                  type: string
                  description: Source event ID (will be merged into target)
                targetId:
                  type: string
                  description: Target event ID (canonical)
      responses:
        '200':
          description: Events merged successfully
          content:
            application/ld+json:
              schema:
                $ref: '#/components/schemas/Event'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/api-keys:
    get:
      operationId: listApiKeys
      summary: List API keys
      description: Retrieve all API keys (without secrets). Requires admin authentication.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of API keys (without secrets)
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApiKeyInfo'

    post:
      operationId: createApiKey
      summary: Create a new API key
      description: Generate a new API key for agent authentication. Returns the API key secret only once. Requires admin authentication.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      requestBody:
        description: API key name and optional metadata (sourceId, expiresAt)
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                sourceId:
                  type: string
                  format: uuid
                expiresAt:
                  type: string
                  format: date-time
      responses:
        '201':
          description: API key created (secret shown once)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyCreated'

  /feeds/changes:
    get:
      operationId: getChangeFeed
      summary: Get change feed
      description: |
        Ordered stream of changes for federation sync. Returns events in 
        sequence order with action type and snapshot.
      tags: [Feeds]
      security: []
      parameters:
        - name: since
          in: query
          description: Cursor from previous response (e.g., seq_1048576)
          schema:
            type: string
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Change feed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChangeFeedResponse'

  /admin/review-queue:
    get:
      operationId: listReviewQueue
      summary: List review queue entries
      description: |
        Returns events awaiting admin review due to validation warnings or normalization changes.
        Supports filtering by status and pagination.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by review status (defaults to 'pending')
          schema:
            type: string
            enum: [pending, approved, rejected]
            default: pending
        - name: cursor
          in: query
          description: Pagination cursor (review queue entry ID)
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum results per page (default 50, max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Paginated list of review queue entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewQueueListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/review-queue/{id}:
    get:
      operationId: getReviewQueueEntry
      summary: Get review queue entry details
      description: |
        Retrieve detailed information for a specific review queue entry, including
        original payload, normalized payload, detected changes, and validation warnings.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Review queue entry ID
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Review queue entry details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewQueueDetail'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/review-queue/{id}/approve:
    post:
      operationId: approveReviewQueueEntry
      summary: Approve a review queue entry
      description: |
        Approve an event in the review queue and publish it. The event's lifecycle
        state will be updated to 'published' and it will appear in public listings.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Review queue entry ID
          schema:
            type: integer
            minimum: 1
      requestBody:
        description: Optional review notes for approval
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                notes:
                  type: string
                  description: Optional review notes
            examples:
              withNotes:
                summary: Approval with notes
                value:
                  notes: "Date corrections look good, publishing"
              withoutNotes:
                summary: Simple approval
                value: {}
      responses:
        '200':
          description: Review approved and event published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewQueueDetail'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/review-queue/{id}/reject:
    post:
      operationId: rejectReviewQueueEntry
      summary: Reject a review queue entry
      description: |
        Reject an event in the review queue and mark it as deleted. The event will
        return HTTP 410 Gone with a tombstone and will not appear in public listings.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Review queue entry ID
          schema:
            type: integer
            minimum: 1
      requestBody:
        description: Rejection reason (required) explaining why the event was rejected
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  description: Required rejection reason
            examples:
              invalidDates:
                summary: Reject due to invalid dates
                value:
                  reason: "Event dates are in the past and cannot be corrected"
              spam:
                summary: Reject spam event
                value:
                  reason: "Spam submission - not a legitimate event"
      responses:
        '200':
          description: Review rejected and event deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewQueueDetail'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/review-queue/{id}/fix:
    post:
      operationId: fixReviewQueueEntry
      summary: Fix event dates and approve
      description: |
        Apply date corrections to an event and approve it for publication.
        This endpoint is intended for fixing date-related issues detected during normalization.
        
        Note: Currently this endpoint only marks the review as approved with correction notes.
        Full date correction implementation is tracked in srv-trg.
      tags: [Admin]
      x-internal: true
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Review queue entry ID
          schema:
            type: integer
            minimum: 1
      requestBody:
        description: Date corrections to apply to the event (startDate and/or endDate)
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [corrections]
              properties:
                corrections:
                  type: object
                  description: Date corrections to apply
                  properties:
                    startDate:
                      type: string
                      format: date-time
                      description: Corrected start date
                    endDate:
                      type: string
                      format: date-time
                      description: Corrected end date
                notes:
                  type: string
                  description: Optional notes about the corrections
            examples:
              fixEndDate:
                summary: Fix reversed end date
                value:
                  corrections:
                    endDate: "2026-03-15T22:00:00Z"
                  notes: "Added 24 hours to fix reversed dates"
              fixBothDates:
                summary: Fix both dates
                value:
                  corrections:
                    startDate: "2026-03-15T19:00:00Z"
                    endDate: "2026-03-15T22:00:00Z"
                  notes: "Corrected timezone offset"
      responses:
        '200':
          description: Dates corrected and review approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewQueueDetail'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/login:
    post:
      operationId: login
      summary: Admin login
      description: Authenticate admin user and receive JWT token
      tags: [Admin]
      x-internal: true
      requestBody:
        description: Admin credentials (email and password) for authentication
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  expiresAt:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'

  /healthz:
    get:
      operationId: healthLiveness
      summary: Liveness probe
      description: Check if the service is alive and running. Used by orchestrators (Kubernetes, etc.) to determine if the service should be restarted.
      tags: [Health]
      security: []
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /readyz:
    get:
      operationId: healthReadiness
      summary: Readiness probe
      description: Check if the service is ready to accept traffic. Verifies database connectivity and other dependencies.
      tags: [Health]
      security: []
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
                  checks:
                    type: object
                    properties:
                      database:
                        type: string
        '503':
          description: Service not ready

  /.well-known/sel-profile:
    get:
      operationId: getSELProfile
      summary: SEL node profile discovery
      description: |
        Returns this node's SEL profile information for federation discovery.
        Required by SEL Interoperability Profile ยง1.7.
      tags: [Health]
      security: []
      responses:
        '200':
          description: SEL profile information
          content:
            application/json:
              schema:
                type: object
                required: [profile, version, node, updated]
                properties:
                  profile:
                    type: string
                    format: uri
                    example: https://togather.foundation/sel/profiles/v0.1
                  version:
                    type: string
                    example: "0.1.0"
                  node:
                    type: string
                    format: uri
                    example: https://toronto.togather.foundation
                  updated:
                    type: string
                    format: date-time

  /openapi.json:
    get:
      operationId: getOpenApiSpec
      summary: OpenAPI specification
      description: Retrieve the OpenAPI 3.1 specification for this API in JSON format. Useful for API documentation and client generation.
      tags: [Health]
      security: []
      responses:
        '200':
          description: OpenAPI 3.1 specification
          content:
            application/json:
              schema:
                type: object

components:
  securitySchemes:
    apiKey:
      type: http
      scheme: bearer
      description: API key for agent access
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for admin access

  parameters:
    eventId:
      name: id
      in: path
      required: true
      description: Event ULID
      schema:
        type: string
        pattern: '^[0-9A-HJKMNP-TV-Z]{26}$'

    startDate:
      name: startDate
      in: query
      description: Filter events starting on or after this date (ISO8601)
      schema:
        type: string
        format: date

    endDate:
      name: endDate
      in: query
      description: Filter events starting on or before this date (ISO8601)
      schema:
        type: string
        format: date

    city:
      name: city
      in: query
      description: Filter by city/locality
      schema:
        type: string

    venueId:
      name: venueId
      in: query
      description: Filter by venue ULID
      schema:
        type: string

    organizerId:
      name: organizerId
      in: query
      description: Filter by organizer ULID
      schema:
        type: string

    lifecycleState:
      name: state
      in: query
      description: Filter by lifecycle state
      schema:
        type: string
        enum: [draft, published, postponed, rescheduled, sold_out, cancelled, completed]

    eventDomain:
      name: domain
      in: query
      description: Filter by event domain
      schema:
        type: string
        enum: [arts, music, culture, sports, community, education, general]

    query:
      name: q
      in: query
      description: Free-text search on name and description
      schema:
        type: string

    keywords:
      name: keywords
      in: query
      description: Filter by keywords (comma-separated)
      schema:
        type: string

    after:
      name: after
      in: query
      description: |
        Opaque cursor for pagination (obtained from previous response's `next_cursor`).
        Cursors are base64url-encoded strings - treat as opaque, do not parse or modify.
        Example: `MTcwNjg4NjAwMDAwMDAwMDAwMDowMUhZWDNLUVc3RVJUV jlYTkJNMlA4UUpaRg`
      schema:
        type: string
        example: "MTcwNjg4NjAwMDAwMDAwMDAwMDowMUhZWDNLUVc3RVJUV jlYTkJNMlA4UUpaRg"

    limit:
      name: limit
      in: query
      description: Maximum results per page (default 50, max 200)
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50

  schemas:
    Event:
      type: object
      description: A cultural event in Schema.org Event format with SEL extensions for provenance and federation
      required: ['@id', '@type', name, startDate, location]
      properties:
        '@context':
          oneOf:
            - type: string
            - type: array
              items:
                type: string
            - type: object
          description: |
            JSON-LD context. May be a string URL, an array of URLs, or an embedded context object.
            Per JSON-LD specification, all three forms are valid.
        '@id':
          type: string
          format: uri
          description: Canonical URI for this event
        '@type':
          type: string
          enum: [Event, EventSeries]
        name:
          type: string
        description:
          type: string
        eventStatus:
          type: string
          format: uri
        eventAttendanceMode:
          type: string
          format: uri
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
        doorTime:
          type: string
          format: date-time
        location:
          $ref: '#/components/schemas/Place'
        organizer:
          $ref: '#/components/schemas/Organization'
        image:
          type: string
          format: uri
        url:
          type: string
          format: uri
        inLanguage:
          type: array
          items:
            type: string
        isAccessibleForFree:
          type: boolean
        offers:
          $ref: '#/components/schemas/Offer'
        sameAs:
          type: array
          items:
            type: string
            format: uri
        'sel:originNode':
          type: string
          format: uri
        'sel:ingestedAt':
          type: string
          format: date-time
        'sel:confidence':
          type: number
          minimum: 0
          maximum: 1
        license:
          type: string
          format: uri

    EventInput:
      type: object
      description: Input schema for creating or updating an event. Minimal required fields with optional Schema.org properties
      required: [name, startDate]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 500
        description:
          type: string
          maxLength: 10000
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
        doorTime:
          type: string
          format: date-time
        location:
          oneOf:
            - $ref: '#/components/schemas/PlaceInput'
            - $ref: '#/components/schemas/VirtualLocationInput'
        virtualLocation:
          $ref: '#/components/schemas/VirtualLocationInput'
        organizer:
          $ref: '#/components/schemas/OrganizationInput'
        image:
          type: string
          format: uri
        url:
          type: string
          format: uri
        keywords:
          type: array
          items:
            type: string
        inLanguage:
          type: array
          items:
            type: string
        isAccessibleForFree:
          type: boolean
        offers:
          $ref: '#/components/schemas/OfferInput'
        source:
          $ref: '#/components/schemas/SourceInput'

    EventUpdateInput:
      description: Schema for updating an existing event with version control for optimistic locking
      allOf:
        - $ref: '#/components/schemas/EventInput'
        - type: object
          properties:
            version:
              type: integer
              description: Current version for optimistic locking
            lifecycleState:
              type: string
              enum: [draft, published, postponed, rescheduled, sold_out, cancelled, completed]

    Place:
      description: A physical location or venue where events occur, using Schema.org Place vocabulary
      type: object
      required: ['@type', name]
      properties:
        '@id':
          type: string
          format: uri
        '@type':
          type: string
          enum: [Place]
        name:
          type: string
        address:
          $ref: '#/components/schemas/PostalAddress'
        geo:
          $ref: '#/components/schemas/GeoCoordinates'
        telephone:
          type: string
        url:
          type: string
          format: uri
        sameAs:
          type: array
          items:
            type: string
            format: uri

    PlaceInput:
      description: Input schema for specifying event locations with address and geographic coordinates
      type: object
      required: [name]
      properties:
        '@id':
          type: string
          format: uri
          description: Reference to existing place by URI
        name:
          type: string
        streetAddress:
          type: string
        addressLocality:
          type: string
        addressRegion:
          type: string
        postalCode:
          type: string
        addressCountry:
          type: string
        latitude:
          type: number
        longitude:
          type: number

    VirtualLocationInput:
      description: Input schema for online/virtual event locations with URL
      type: object
      required: [url]
      properties:
        '@type':
          type: string
          enum: [VirtualLocation]
        url:
          type: string
          format: uri
        name:
          type: string

    PostalAddress:
      description: Physical mailing address using Schema.org PostalAddress vocabulary
      type: object
      properties:
        '@type':
          type: string
          enum: [PostalAddress]
        streetAddress:
          type: string
        addressLocality:
          type: string
        addressRegion:
          type: string
        postalCode:
          type: string
        addressCountry:
          type: string

    GeoCoordinates:
      description: Geographic coordinates (latitude/longitude) using Schema.org GeoCoordinates vocabulary
      type: object
      properties:
        '@type':
          type: string
          enum: [GeoCoordinates]
        latitude:
          type: number
        longitude:
          type: number

    Organization:
      description: An organization or person that organizes events, using Schema.org Organization vocabulary
      type: object
      required: ['@type', name]
      properties:
        '@id':
          type: string
          format: uri
        '@type':
          type: string
          enum: [Organization]
        name:
          type: string
        alternateName:
          type: string
        url:
          type: string
          format: uri
        sameAs:
          type: array
          items:
            type: string
            format: uri

    OrganizationInput:
      description: Input schema for specifying event organizers
      type: object
      required: [name]
      properties:
        '@id':
          type: string
          format: uri
        name:
          type: string
        url:
          type: string
          format: uri

    Offer:
      description: Ticketing or pricing information using Schema.org Offer vocabulary
      type: object
      properties:
        '@type':
          type: string
          enum: [Offer]
        url:
          type: string
          format: uri
        price:
          type: string
        priceCurrency:
          type: string
        availability:
          type: string
          format: uri

    OfferInput:
      description: Input schema for ticket/pricing offers
      type: object
      properties:
        url:
          type: string
          format: uri
        price:
          type: string
        priceCurrency:
          type: string
          default: CAD

    SourceInput:
      description: Provenance metadata identifying the data source and attribution for submitted events
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Source URL for provenance
        eventId:
          type: string
          description: External system's event ID

    EventListResponse:
      description: Paginated list of events with cursor-based pagination
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Event'
        next_cursor:
          type: string
          description: Cursor for next page

    PlaceListResponse:
      description: Paginated list of places (venues) with cursor-based pagination
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Place'
        next_cursor:
          type: string

    OrganizationListResponse:
      description: Paginated list of organizations with cursor-based pagination
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Organization'
        next_cursor:
          type: string

    ChangeFeedResponse:
      description: Federation change feed containing sequential updates for event synchronization
      type: object
      required: [cursor, changes]
      properties:
        cursor:
          type: string
          description: Current cursor position
        changes:
          type: array
          items:
            $ref: '#/components/schemas/ChangeEntry'
        next_cursor:
          type: string
          description: Cursor for next page

    ChangeEntry:
      description: Single change record in the federation feed with action type and snapshot
      type: object
      required: [action, uri, changed_at]
      properties:
        action:
          type: string
          enum: [create, update, delete]
        uri:
          type: string
          format: uri
        changed_at:
          type: string
          format: date-time
        changed_fields:
          type: array
          items:
            type: string
        snapshot:
          $ref: '#/components/schemas/Event'

    ApiKeyInfo:
      description: API key metadata (without secret) for agent authentication management
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        prefix:
          type: string
          description: First 8 chars of key
        sourceId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        lastUsedAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
        isActive:
          type: boolean

    ApiKeyCreated:
      description: Response when creating a new API key, includes the secret (shown only once)
      allOf:
        - $ref: '#/components/schemas/ApiKeyInfo'
        - type: object
          required: [key]
          properties:
            key:
              type: string
              description: Full API key (shown only once)

    ReviewQueueListResponse:
      description: Paginated list of events awaiting admin review
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReviewQueueItem'
        next_cursor:
          type: string
          description: Cursor for next page (review queue entry ID)

    ReviewQueueItem:
      description: Summary of a review queue entry with event ID and reason for review
      type: object
      required: [id, eventId, warnings, status, createdAt]
      properties:
        id:
          type: integer
          description: Review queue entry ID
        eventId:
          type: string
          description: Event ULID
        eventName:
          type: string
          description: Name of the event (from original payload)
        eventStartTime:
          type: string
          format: date-time
          description: Event start time
        eventEndTime:
          type: string
          format: date-time
          description: Event end time
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/ValidationWarning'
          description: Validation warnings that triggered review
        status:
          type: string
          enum: [pending, approved, rejected]
          description: Current review status
        createdAt:
          type: string
          format: date-time
          description: When the entry was created
        reviewedBy:
          type: string
          description: Email of admin who reviewed (if reviewed)
        reviewedAt:
          type: string
          format: date-time
          description: When the review was completed (if reviewed)

    ReviewQueueDetail:
      description: Detailed review queue entry including original payload, normalized payload, and detected changes
      type: object
      required: [id, eventId, status, warnings, original, normalized, changes, createdAt]
      properties:
        id:
          type: integer
          description: Review queue entry ID
        eventId:
          type: string
          description: Event ULID
        status:
          type: string
          enum: [pending, approved, rejected]
          description: Current review status
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/ValidationWarning'
          description: Validation warnings that triggered review
        original:
          type: object
          description: Original event payload as submitted
        normalized:
          type: object
          description: Normalized event payload after corrections
        changes:
          type: array
          items:
            $ref: '#/components/schemas/ChangeDetail'
          description: List of changes made during normalization
        createdAt:
          type: string
          format: date-time
          description: When the entry was created
        reviewedBy:
          type: string
          description: Email of admin who reviewed (if reviewed)
        reviewedAt:
          type: string
          format: date-time
          description: When the review was completed (if reviewed)
        reviewNotes:
          type: string
          description: Notes from the reviewer (if approved with notes)
        rejectionReason:
          type: string
          description: Reason for rejection (if rejected)

    ValidationWarning:
      description: Warning message from event validation or normalization process
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          description: Warning code (e.g., "REVERSED_DATES", "MISSING_END_DATE")
        message:
          type: string
          description: Human-readable warning message
        field:
          type: string
          description: Field path that triggered the warning
        severity:
          type: string
          enum: [info, warning, error]
          description: Warning severity level

    ChangeDetail:
      description: Record of a single field change made during event normalization
      type: object
      required: [field, original, corrected, reason]
      properties:
        field:
          type: string
          description: Field that was changed (e.g., "endDate")
        original:
          description: Original value before normalization (can be any type)
          example: "2026-03-15T22:00:00Z"
          anyOf:
            - type: string
            - type: number
            - type: boolean
            - type: object
            - type: array
            - type: "null"
        corrected:
          description: Corrected value after normalization (can be any type)
          example: "2026-03-16T22:00:00Z"
          anyOf:
            - type: string
            - type: number
            - type: boolean
            - type: object
            - type: array
            - type: "null"
        reason:
          type: string
          description: Explanation of why the change was made

    ProblemDetails:
      type: object
      required: [type, title, status]
      description: RFC 7807 Problem Details
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string

    Tombstone:
      type: object
      description: Response for deleted entities (HTTP 410)
      properties:
        '@context':
          type: string
        '@type':
          type: string
        '@id':
          type: string
          format: uri
        eventStatus:
          type: string
          format: uri
        'sel:tombstone':
          type: boolean
        'sel:deletedAt':
          type: string
          format: date-time
        'sel:deletionReason':
          type: string
        'sel:supersededBy':
          type: string
          format: uri

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

    Unauthorized:
      description: Authentication required
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

    Forbidden:
      description: Insufficient permissions
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

    Gone:
      description: Resource deleted
      content:
        application/ld+json:
          schema:
            $ref: '#/components/schemas/Tombstone'
